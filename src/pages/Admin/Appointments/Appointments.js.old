import React from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { 
  Box, 
  Typography, 
  Button, 
  Paper, 
  useTheme, 
  useMediaQuery,
  Breadcrumbs,
  Link as MuiLink
} from '@mui/material';
import { 
  Add as AddIcon,
  Home as HomeIcon
} from '@mui/icons-material';
import AdminLayout from '../../../components/Layout/AdminLayout';
import AdminAppointmentList from '../../../components/AdminAppointmentList/AdminAppointmentList';

const Appointments = () => {
  const navigate = useNavigate();
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('sm'));
  
  // State for dialogs and notifications
  const [selectedAppointment, setSelectedAppointment] = useState(null);
  const [openEditDialog, setOpenEditDialog] = useState(false);
  const [openDeleteDialog, setOpenDeleteDialog] = useState(false);
  const [snackbar, setSnackbar] = useState({ 
    open: false, 
    message: '', 
    severity: 'success' 
  });

  // Fetch all appointments
  const { loading, error, data, refetch } = useQuery(GET_ALL_APPOINTMENTS, {
    fetchPolicy: 'network-only',
    onError: (error) => {
      console.error('Error loading appointments:', error);
      showSnackbar('Error loading appointments', 'error');
    }
  });

  // Update appointment mutation
  const [updateAppointment] = useMutation(UPDATE_APPOINTMENT, {
    onCompleted: () => {
      refetch();
      setOpenEditDialog(false);
      showSnackbar('Appointment updated successfully', 'success');
    },
    onError: (error) => {
      console.error('Error updating appointment:', error);
      showSnackbar('Error updating appointment', 'error');
    }
  });

  // Delete appointment mutation
  const [deleteAppointment] = useMutation(DELETE_APPOINTMENT, {
    onCompleted: () => {
      refetch();
      setOpenDeleteDialog(false);
      showSnackbar('Appointment deleted successfully', 'success');
    },
    onError: (error) => {
      console.error('Error deleting appointment:', error);
      showSnackbar('Error deleting appointment', 'error');
    }
  });

  const handleNewAppointment = () => {
    navigate('/admin/appointments/new');
  };

  const handleEdit = (appointment) => {
    setSelectedAppointment(appointment);
    setOpenEditDialog(true);
  };

  const handleDelete = (appointment) => {
    setSelectedAppointment(appointment);
    setOpenDeleteDialog(true);
  };

  const handleUpdate = () => {
    const { __typename, ...input } = selectedAppointment;
    updateAppointment({
      variables: {
        id: input.id,
        input: {
          status: input.status,
          // Add other fields you want to update
        }
      }
    });
  };

  const handleConfirmDelete = () => {
    deleteAppointment({
      variables: {
        id: selectedAppointment.id
      }
    });
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setSelectedAppointment(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const showSnackbar = (message, severity = 'success') => {
    setSnackbar({ open: true, message, severity });
  };

  const handleCloseSnackbar = () => {
    setSnackbar(prev => ({ ...prev, open: false }));
  };

  return (
    <AdminLayout>
      <Box 
        sx={{ 
          width: '100%',
          boxSizing: 'border-box',
          flexGrow: 1,
          display: 'flex',
          flexDirection: 'column',
          p: 0,
          pt: 0
        }}
      >
        <Box 
          sx={{
            display: 'flex',
            justifyContent: 'flex-end',
            width: '100%',
            mb: 3
          }}
        >
          <Button
            variant="contained"
            color="primary"
            startIcon={<AddIcon />}
            onClick={handleNewAppointment}
            size={isMobile ? 'medium' : 'medium'}
            sx={{
              minWidth: 180,
              [theme.breakpoints.down('sm')]: {
                width: '100%',
                maxWidth: 'none',
                mt: 1
              }
            }}
          >
            New Appointment
          </Button>
        </Box>

        <Box sx={{ 
          flex: 1,
          display: 'flex',
          flexDirection: 'column',
          pb: 3
        }}>
          <Paper 
            elevation={0}
            sx={{ 
              p: { xs: 2, sm: 3 },
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              backgroundColor: 'background.paper',
              borderRadius: 2,
              width: '100%',
              overflow: 'hidden',
              border: '1px solid',
              borderColor: 'divider'
            }}
          >
            <AdminAppointmentList 
              appointments={data?.allAppointments || []}
              loading={loading}
              error={error}
              onRefresh={() => refetch()}
              onEdit={handleEdit}
              onDelete={handleDelete}
            />
          </Paper>
        </Box>
      </Box>

      {/* Edit Dialog */}
      <Dialog open={openEditDialog} onClose={() => setOpenEditDialog(false)}>
        <DialogTitle>Edit Appointment</DialogTitle>
        <DialogContent>
          {selectedAppointment && (
            <Box sx={{ minWidth: 400, pt: 2 }}>
              <TextField
                select
                fullWidth
                margin="normal"
                label="Status"
                name="status"
                value={selectedAppointment.status || ''}
                onChange={handleInputChange}
              >
                <MenuItem value="PENDING">Pending</MenuItem>
                <MenuItem value="CONFIRMED">Confirmed</MenuItem>
                <MenuItem value="COMPLETED">Completed</MenuItem>
                <MenuItem value="CANCELLED">Cancelled</MenuItem>
              </TextField>
              {/* Add more fields as needed */}
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenEditDialog(false)}>Cancel</Button>
          <Button onClick={handleUpdate} variant="contained" color="primary">
            Update
          </Button>
        </DialogActions>
      </Dialog>

      {/* Delete Confirmation Dialog */}
      <Dialog open={openDeleteDialog} onClose={() => setOpenDeleteDialog(false)}>
        <DialogTitle>Confirm Delete</DialogTitle>
        <DialogContent>
          <p>Are you sure you want to delete this appointment?</p>
          {selectedAppointment && (
            <p><strong>Client:</strong> {selectedAppointment.firstName} {selectedAppointment.lastName}</p>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenDeleteDialog(false)}>Cancel</Button>
          <Button onClick={handleConfirmDelete} variant="contained" color="error">
            Delete
          </Button>
        </DialogActions>
      </Dialog>

      {/* Snackbar for notifications */}
      <Snackbar 
        open={snackbar.open} 
        autoHideDuration={6000} 
        onClose={handleCloseSnackbar}
        anchorOrigin={{ vertical: 'top', horizontal: 'right' }}
      >
        <Alert onClose={handleCloseSnackbar} severity={snackbar.severity} sx={{ width: '100%' }}>
          {snackbar.message}
        </Alert>
      </Snackbar>
    </AdminLayout>
  );
};

export default Appointments;
